<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الفلتر الشرعي للأسهم - Volume4T</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Cairo) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="style.css">
    <style>
        .glass-card {
            background: rgba(25, 28, 36, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Header -->
    <header class="bg-black/30 backdrop-blur-xl sticky top-0 z-50 border-b border-gray-700/50">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-white">Volume4T<span class="text-teal-400">.</span></a>
            <a href="index.html" class="flex items-center text-gray-300 hover:text-white transition-colors bg-white/5 hover:bg-white/10 px-4 py-2 rounded-full">
                <span>العودة للرئيسية</span>
                <i class="fas fa-arrow-left mr-2"></i>
            </a>
        </div>
    </header>

    <main>
        <!-- Sharia Filter Section -->
        <section id="sharia-filter" class="py-20">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h1 class="text-4xl md:text-5xl font-bold text-white">الفلتر الشرعي للأسهم</h1>
                    <p class="text-gray-400 mt-4 max-w-2xl mx-auto">أدخل رمز السهم للتحقق من توافقه مع أحكام الشريعة الإسلامية وفقًا لدار الإفتاء المصرية.</p>
                </div>
                <div class="max-w-2xl mx-auto glass-card p-8 rounded-2xl">
                    <div class="flex items-center bg-gray-900/50 border border-gray-700 rounded-full p-2">
                        <input type="text" id="stock-symbol" placeholder="أدخل رمز السهم هنا..." class="w-full bg-transparent text-white text-lg px-6 py-3 focus:outline-none">
                        <button id="search-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-blue-700 transition-colors mx-2">
                            <i class="fas fa-search"></i>
                            <span class="mr-2">بحث</span>
                        </button>
                    </div>
                </div>

                <div id="results-section" class="max-w-2xl mx-auto glass-card p-8 rounded-2xl mt-8 hidden">
                    <!-- Results will be injected here by JavaScript -->
                </div>
            </div>
        </section>
    </main>
    
    <!-- Footer -->
    <footer class="glass-card pt-12 rounded-t-2xl mt-20">
        <div class="container mx-auto px-6">
            <div class="grid md:grid-cols-4 gap-8">
                <!-- Logo and About -->
                <div class="md:col-span-1">
                    <a href="index.html" class="text-2xl font-bold text-white transition-transform hover:scale-105">Volume4T<span class="text-teal-400">.</span></a>
                    <p class="text-gray-400 mt-4">
                        أتقن فن التداول في الأسواق وانطلق نحو الحرية المالية.
                    </p>
                </div>

                <!-- Quick Links -->
                <div>
                    <h5 class="font-bold text-white mb-4">روابط سريعة</h5>
                    <ul class="space-y-2">
                        <li><a href="packages-hub.html" class="text-gray-400 hover:text-teal-400 transition-colors">الباقات</a></li>
                        <li><a href="results.html" class="text-gray-400 hover:text-teal-400 transition-colors">التحليلات السابقة</a></li>
                        <li><a href="articles.html" class="text-gray-400 hover:text-teal-400 transition-colors">مقالات</a></li>
                        <li><a href="contact.html" class="text-gray-400 hover:text-teal-400 transition-colors">تواصل معنا</a></li>
                    </ul>
                </div>

                <!-- Social Media -->
                <div>
                    <h5 class="font-bold text-white mb-4">تابعنا</h5>
                    <div class="flex space-x-4 space-x-reverse">
                        <a href="#" class="text-gray-400 hover:text-white transition-colors text-2xl footer-social-icon"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors text-2xl footer-social-icon"><i class="fab fa-telegram"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors text-2xl footer-social-icon"><i class="fab fa-youtube"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors text-2xl footer-social-icon"><i class="fab fa-snapchat"></i></a>
                    </div>
                </div>

                <!-- Payment Methods -->
                <div>
                    <h5 class="font-bold text-white mb-4">طرق الدفع المتاحة</h5>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" class="h-8 bg-white p-1 rounded">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/a/a4/Mastercard_2019_logo.svg" alt="MasterCard" class="h-8">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/d/d6/Visa_2021.svg" alt="Visa" class="h-8">
                    </div>
                </div>
            </div>
            <div class="mt-8 border-t border-gray-700 pt-6 pb-8 flex flex-col md:flex-row justify-between items-center">
                <p class="text-gray-500 text-sm">&copy; 2025 جميع الحقوق محفوظة | Volume4T.</p>
                <div class="flex space-x-4 space-x-reverse mt-4 md:mt-0">
                    <a href="#" class="text-gray-500 hover:text-white text-sm">سياسة الخصوصية</a>
                    <a href="#" class="text-gray-500 hover:text-white text-sm">شروط الاستخدام</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const searchButton = document.getElementById('search-btn');
        const resultsSection = document.getElementById('results-section');
        const stockSymbolInput = document.getElementById('stock-symbol');
        const apiKey = '4DQLSX0TL0LJ5KTA';

        const fetchFinancialData = async (symbol) => {
            const overviewUrl = `https://www.alphavantage.co/query?function=OVERVIEW&symbol=${symbol}&apikey=${apiKey}`;
            const balanceSheetUrl = `https://www.alphavantage.co/query?function=BALANCE_SHEET&symbol=${symbol}&apikey=${apiKey}`;
            const incomeStatementUrl = `https://www.alphavantage.co/query?function=INCOME_STATEMENT&symbol=${symbol}&apikey=${apiKey}`;

            const [overviewResponse, balanceSheetResponse, incomeStatementResponse] = await Promise.all([
                fetch(overviewUrl),
                fetch(balanceSheetUrl),
                fetch(incomeStatementUrl)
            ]);

            if (!overviewResponse.ok || !balanceSheetResponse.ok || !incomeStatementResponse.ok) {
                throw new Error('Failed to fetch financial data.');
            }

            const overviewData = await overviewResponse.json();
            const balanceSheetData = await balanceSheetResponse.json();
            const incomeStatementData = await incomeStatementResponse.json();

            // console.log("Overview Data:", overviewData);

            if (overviewData.Information || balanceSheetData.Information || incomeStatementData.Information) {
                throw new Error('API limit reached. Please try again later. (Alpha Vantage free tier limit is 25 requests per day).');
            }
            
            if (!overviewData.MarketCapitalization || overviewData.MarketCapitalization === "None") {
                throw new Error('Could not retrieve market capitalization for the stock.');
            }

            return { symbol: symbol, overview: overviewData, balanceSheet: balanceSheetData, incomeStatement: incomeStatementData };
        };

        const calculateShariaCompliance = (data) => {
            const { overview, balanceSheet, incomeStatement } = data;

            // console.log("Raw Data:", data);

            const latestBalanceSheet = balanceSheet.annualReports[0];
            const latestIncomeStatement = incomeStatement.annualReports[0];
            const marketCap = parseFloat(overview.MarketCapitalization);

            // console.log("Market Cap:", marketCap);

            // --- 1. Debt to Market Cap Ratio ---
            const totalLiabilities = parseFloat(latestBalanceSheet.totalLiabilities || 0);
            const debtToMarketCapRatio = (totalLiabilities / marketCap) * 100;
            // console.log("Debt to Market Cap Ratio:", debtToMarketCapRatio);

            // --- 2. Illiquid Assets to Market Cap Ratio ---
            const totalAssets = parseFloat(latestBalanceSheet.totalAssets || 0);
            const cashAndEquivalents = parseFloat(latestBalanceSheet.cashAndCashEquivalentsAtCarryingValue || 0);
            const accountsReceivable = parseFloat(latestBalanceSheet.currentNetReceivables || 0);
            const illiquidAssets = totalAssets - cashAndEquivalents - accountsReceivable;
            const illiquidAssetsToMarketCapRatio = (illiquidAssets / marketCap) * 100;
            // console.log("Illiquid Assets to Market Cap Ratio:", illiquidAssetsToMarketCapRatio);

            // --- 3. Interest-based Income to Total Revenue Ratio ---
            const interestIncome = parseFloat(latestIncomeStatement.interestIncome || 0);
            const totalRevenue = parseFloat(latestIncomeStatement.totalRevenue || 0);
            const nonPermissibleRevenueRatio = totalRevenue > 0 ? (interestIncome / totalRevenue) * 100 : 0;
            // console.log("Non-permissible Revenue Ratio:", nonPermissibleRevenueRatio);

            const isCompliant = debtToMarketCapRatio <= 33 && illiquidAssetsToMarketCapRatio >= 25 && nonPermissibleRevenueRatio <= 5;
            // console.log("Is Compliant:", isCompliant);

            return {
                symbol: data.symbol,
                companyName: overview.Name,
                market: `${overview.AssetType} on ${overview.Exchange}`,
                isCompliant: isCompliant,
                lastUpdated: new Date().toLocaleDateString('ar-EG'),
                report: {
                    debtToMarketCapRatio: {
                        value: debtToMarketCapRatio.toFixed(2),
                        limit: 33,
                        isCompliant: debtToMarketCapRatio <= 33
                    },
                    illiquidAssetsToMarketCapRatio: {
                        value: illiquidAssetsToMarketCapRatio.toFixed(2),
                        limit: 25,
                        isCompliant: illiquidAssetsToMarketCapRatio >= 25
                    },
                    nonPermissibleRevenue: {
                        value: nonPermissibleRevenueRatio.toFixed(2),
                        limit: 5,
                        isCompliant: nonPermissibleRevenueRatio <= 5
                    }
                }
            };
        };

        const displayResults = (data) => {
            const complianceText = data.isCompliant ? 'متوافق مع الشريعة' : 'غير متوافق مع الشريعة';
            const complianceColor = data.isCompliant ? 'text-green-400' : 'text-red-400';

            resultsSection.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-center">نتائج البحث</h2>
                <div class="border-t border-gray-700 pt-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-2xl font-bold">${data.companyName} (${data.symbol})</h3>
                            <p class="text-lg text-gray-400">${data.market}</p>
                        </div>
                        <div class="text-left">
                            <p class="text-2xl font-bold ${complianceColor}">${complianceText}</p>
                            <p class="text-sm text-gray-500">وفقًا لمعايير دار الإفتاء المصرية (تقريبي)</p>
                            <p class="text-sm text-gray-500">آخر تحديث: ${data.lastUpdated}</p>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h4 class="text-xl font-bold mb-2">تفاصيل التقرير:</h4>
                        <ul class="list-disc list-inside space-y-2 text-gray-300">
                            <li>نسبة الديون إلى القيمة السوقية: ${data.report.debtToMarketCapRatio.value}% (الحد المسموح: ${data.report.debtToMarketCapRatio.limit}%)</li>
                            <li>نسبة الأصول غير السائلة إلى القيمة السوقية: ${data.report.illiquidAssetsToMarketCapRatio.value}% (الحد الأدنى المطلوب: ${data.report.illiquidAssetsToMarketCapRatio.limit}%)</li>
                            <li>نسبة الإيرادات غير المباحة: ${data.report.nonPermissibleRevenue.value}% (الحد المسموح: ${data.report.nonPermissibleRevenue.limit}%)</li>
                        </ul>
                    </div>
                    <div class="mt-6 text-xs text-gray-500">
                        <p><strong>إخلاء مسؤولية:</strong> هذا الفحص هو أداة مساعدة فقط وقد لا تكون النتائج دقيقة 100%. القرار النهائي يعود للمستثمر بعد مراجعة القوائم المالية للشركة.</p>
                    </div>
                </div>
            `;
            resultsSection.classList.remove('hidden');
        };

        if(searchButton) {
            searchButton.addEventListener('click', async () => {
                const symbol = stockSymbolInput.value;
                if (!symbol) return;

                searchButton.disabled = true;
                searchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="mr-2">جاري البحث...</span>';
                resultsSection.classList.add('hidden');

                try {
                    const financialData = await fetchFinancialData(symbol);
                    const complianceData = calculateShariaCompliance(financialData);
                    displayResults(complianceData);
                } catch (error) {
                    console.error("Error fetching or processing data:", error);
                    resultsSection.innerHTML = `<p class="text-center text-red-400">حدث خطأ: ${error.message}</p>`;
                    resultsSection.classList.remove('hidden');
                } finally {
                    searchButton.disabled = false;
                    searchButton.innerHTML = '<i class="fas fa-search"></i><span class="mr-2">بحث</span>';
                }
            });
        }
    </script>

</body>
</html>