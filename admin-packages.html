<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الباقات - لوحة التحكم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .glass-card {
            background: rgba(25, 28, 36, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tab-active {
            background-color: #2563eb; /* blue-600 */
            color: white;
        }
        .tab-inactive {
            background-color: transparent;
            color: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    
    <div id="admin-content" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-black/30 backdrop-blur-xl sticky top-0 z-50 border-b border-gray-700/50">
            <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-white">إدارة الباقات</h1>
                <a href="dashboard.html" class="flex items-center text-gray-300 hover:text-white transition-colors bg-white/5 hover:bg-white/10 px-4 py-2 rounded-full">
                    <span>العودة للوحة التحكم</span>
                    <i class="fas fa-arrow-left mr-2"></i>
                </a>
            </div>
        </header>

        <main class="container mx-auto px-6 py-12">
            <!-- Market Tabs -->
            <div class="mb-8 flex justify-center border-b border-gray-700">
                <button id="tab-saudi" class="tab-button tab-active py-3 px-8 text-lg font-bold rounded-t-lg focus:outline-none">السوق السعودي</button>
                <button id="tab-american" class="tab-button tab-inactive py-3 px-8 text-lg font-bold rounded-t-lg focus:outline-none">السوق الأمريكي</button>
            </div>

            <!-- Tab Content -->
            <div id="tab-content-saudi">
                <!-- Content for Saudi Market will be generated by JS -->
            </div>

            <div id="tab-content-american" class="hidden">
                <!-- Content for American Market will be generated by JS -->
            </div>
        </main>
    </div>

    <script type="module">
        import { protectPage } from './auth-guard.js';
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBkajwsO5ME11NravlECLJSlk4GN0xGbGE",
            authDomain: "sco4mfortelegram.firebaseapp.com",
            projectId: "sco4mfortelegram",
            storageBucket: "sco4mfortelegram.appspot.com",
            messagingSenderId: "72437321483",
            appId: "1:72437321483:web:e89c4ff409f9c477605c0e",
            measurementId: "G-0BZWRPSB76"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        protectPage((user) => {
            document.getElementById('admin-content').classList.remove('hidden');

            const saudiTab = document.getElementById('tab-saudi');
            const americanTab = document.getElementById('tab-american');
            const saudiContent = document.getElementById('tab-content-saudi');
            const americanContent = document.getElementById('tab-content-american');

            saudiTab.addEventListener('click', () => switchTab('saudi'));
            americanTab.addEventListener('click', () => switchTab('american'));

            function switchTab(market) {
                if (market === 'saudi') {
                    saudiTab.classList.replace('tab-inactive', 'tab-active');
                    americanTab.classList.replace('tab-active', 'tab-inactive');
                    saudiContent.classList.remove('hidden');
                    americanContent.classList.add('hidden');
                } else {
                    americanTab.classList.replace('tab-inactive', 'tab-active');
                    saudiTab.classList.replace('tab-active', 'tab-inactive');
                    americanContent.classList.remove('hidden');
                    saudiContent.classList.add('hidden');
                }
            }

            const packageTypes = { modaraba: 'المضاربة', swing: 'Swing', investment: 'الاستثمار' };
            const tiers = { basic: 'Basic', plus: 'Plus', pro: 'Pro' };

            function createMarketHTML(marketId) {
                let html = '<div class="grid lg:grid-cols-3 gap-8">';
                for (const typeKey in packageTypes) {
                    html += `<div class="glass-card p-6 rounded-2xl"><h3 class="text-2xl font-bold text-white mb-6 text-center border-b border-gray-700 pb-4">باقات ${packageTypes[typeKey]}</h3>`;
                    for (const tierKey in tiers) {
                        const formId = `${marketId}-${typeKey}-${tierKey}-form`;
                        html += `
                            <form id="${formId}" class="mb-6 border-b border-gray-700 pb-6">
                                <h4 class="text-xl font-bold text-teal-400 mb-3">باقة ${tiers[tierKey]}</h4>
                                <input type="text" name="price" placeholder="السعر" class="w-full mb-3 bg-gray-900/50 text-white rounded-lg p-2 border border-gray-700">
                                <textarea name="features" rows="3" placeholder="المميزات (ميزة في كل سطر)" class="w-full mb-3 bg-gray-900/50 text-white rounded-lg p-2 border border-gray-700"></textarea>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">حفظ</button>
                            </form>`;
                    }
                    html += '</div>';
                }
                return html + '</div>';
            }

            async function loadAllData() {
                saudiContent.innerHTML = createMarketHTML('saudi');
                americanContent.innerHTML = createMarketHTML('american');
                await populateMarketForms('saudi');
                await populateMarketForms('american');
                addFormEventListeners();
            }

            async function populateMarketForms(marketId) {
                const docRef = doc(db, "markets", marketId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const marketData = docSnap.data();
                    for (const typeKey in marketData) {
                        for (const tierKey in marketData[typeKey]) {
                            const form = document.getElementById(`${marketId}-${typeKey}-${tierKey}-form`);
                            if(form) {
                                form.price.value = marketData[typeKey][tierKey].price || '';
                                form.features.value = (marketData[typeKey][tierKey].features || []).join('\n');
                            }
                        }
                    }
                }
            }

            function addFormEventListeners() {
                document.querySelectorAll('form').forEach(form => {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const [marketId, typeKey, tierKey] = e.target.id.split('-');
                        
                        const price = e.target.price.value;
                        const features = e.target.features.value.split('\n').filter(f => f.trim() !== '');

                        const dataToSave = {
                            [typeKey]: { [tierKey]: {
                                price: price,
                                features: features
                            }}
                        };

                        try {
                            const docRef = doc(db, "markets", marketId);
                            await setDoc(docRef, dataToSave, { merge: true });
                            alert(`تم حفظ باقة "${tiers[tierKey]}" في قسم "${packageTypes[typeKey]}" بنجاح!`);
                        } catch (error) {
                            console.error("Error saving data: ", error);
                            alert("حدث خطأ أثناء الحفظ.");
                        }
                    });
                });
            }

            loadAllData();
        });
    </script>
</body>
</html>
